#!/usr/bin/env bash 
# install and configure nginx
REPL="\s\?server_name \(.*\);"
REPL_WITH="\tserver_name \1; \\n\trewrite ^\/.+?_me https:\/\/www.youtube.com\/watch?v=QH2-TGULwu4 permanent;"
apt update
apt-get install ufw 
OUT_CONF="/etc/nginx/sites-available/default"
apt-get install nginx 
ufw allow "Nginx http"
mkdir -p /var/www/html
chown "$USER":"$USER" /var/www/html 
echo "Hello World!" > /var/www/html/index.html
# idempotent 
if ! ( grep -c 'rewrite' "$OUT_CONF" ); then 
    {
        # file manipulation
        sed -i "/^[^#]/ s/$REPL/$REPL_WITH/1" $OUT_CONF
    }
fi

if ! (nginx -t); then { exit 1; }; fi
if  ( pgrep -c nginx ); then 
    service nginx start 
else 
    service nginx restart
fi
exit 0 
